<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HANES MES — ERD Explorer</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:system-ui,-apple-system,sans-serif;background:#0f172a;color:#e2e8f0;display:flex;height:100vh;overflow:hidden}
.panel{width:280px;min-width:260px;background:#1e293b;border-right:1px solid #334155;display:flex;flex-direction:column;overflow:hidden}
.panel-section{padding:10px 12px;border-bottom:1px solid #334155}
.panel-section h3{font-size:10px;text-transform:uppercase;letter-spacing:.7px;color:#94a3b8;margin-bottom:6px}
.stats{display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-bottom:4px}
.stat-box{background:#0f172a;border:1px solid #334155;border-radius:5px;padding:5px 8px;text-align:center}
.stat-box .num{font-size:16px;font-weight:700;color:#60a5fa}.stat-box .lbl{font-size:8px;color:#64748b;text-transform:uppercase}
.preset-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px}
.preset-btn{padding:5px 6px;border:1px solid #475569;border-radius:5px;background:#1e293b;color:#cbd5e1;font-size:10px;cursor:pointer;transition:.15s;text-align:center}
.preset-btn:hover{border-color:#60a5fa;color:#93c5fd}.preset-btn.active{background:#1e3a5f;border-color:#3b82f6;color:#93c5fd}
.check-group{display:flex;flex-direction:column;gap:3px}
.check-item{display:flex;align-items:center;gap:5px;font-size:11px;cursor:pointer;padding:1px 0}
.check-item input{accent-color:#3b82f6;cursor:pointer}
.color-dot{width:9px;height:9px;border-radius:50%;display:inline-block}
.tbl-count{font-size:9px;color:#64748b;margin-left:auto}
.search-box{width:100%;background:#0f172a;border:1px solid #475569;border-radius:5px;color:#e2e8f0;padding:5px 8px;font-size:11px;margin-bottom:6px}
.search-box:focus{outline:none;border-color:#3b82f6}
.rel-toggle{display:flex;gap:6px;margin-top:4px}
.rel-toggle label{font-size:10px;display:flex;align-items:center;gap:4px}

/* Detail panel */
.detail-area{flex:1;overflow-y:auto;padding:8px 12px}
.detail-area h3{font-size:10px;text-transform:uppercase;letter-spacing:.7px;color:#94a3b8;margin-bottom:6px}
.detail-card{background:#0f172a;border:1px solid #334155;border-radius:6px;padding:8px 10px;font-size:10px}
.detail-card .dt-name{font-size:12px;font-weight:700;color:#93c5fd;margin-bottom:2px}
.detail-card .dt-domain{font-size:9px;color:#64748b;margin-bottom:6px}
.col-list{max-height:280px;overflow-y:auto}
.col-row{display:flex;align-items:center;gap:4px;padding:2px 0;border-bottom:1px solid #1e293b;font-size:9.5px}
.col-row:last-child{border:none}
.col-pk{color:#fbbf24;font-weight:700;font-size:8px}.col-fk{color:#f472b6;font-size:8px}
.col-name{color:#e2e8f0;flex:1}.col-type{color:#64748b;font-size:9px}
.col-null{color:#475569;font-size:8px}
.no-detail{color:#64748b;font-size:11px;font-style:italic}

/* Main */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden}
.toolbar{display:flex;align-items:center;gap:8px;padding:7px 12px;background:#1e293b;border-bottom:1px solid #334155}
.toolbar .title{font-size:13px;font-weight:700;color:#f1f5f9;flex:1}.toolbar .title span{color:#f59e0b}
.zoom-btn{width:26px;height:26px;border:1px solid #475569;border-radius:5px;background:#1e293b;color:#cbd5e1;cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center}
.zoom-btn:hover{border-color:#60a5fa;color:#93c5fd}
.zoom-label{font-size:10px;color:#64748b;min-width:36px;text-align:center}
.canvas-wrap{flex:1;position:relative;overflow:hidden;background:#0f172a}
.canvas-wrap svg{width:100%;height:100%}

/* Prompt */
.prompt-area{background:#1e293b;border-top:1px solid #334155;padding:8px 12px;max-height:100px;overflow-y:auto}
.prompt-area .prompt-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px}
.prompt-area h3{font-size:10px;text-transform:uppercase;letter-spacing:.7px;color:#94a3b8}
.copy-btn{padding:3px 10px;border:1px solid #475569;border-radius:5px;background:#1e293b;color:#cbd5e1;cursor:pointer;font-size:10px}
.copy-btn:hover{border-color:#10b981;color:#6ee7b7}
.copy-btn.copied{border-color:#10b981;color:#10b981}
.prompt-text{font-family:'Cascadia Code','Fira Code',monospace;font-size:10px;color:#94a3b8;white-space:pre-wrap;line-height:1.4}

/* Tooltip */
.tooltip{position:fixed;background:#334155;border:1px solid #475569;border-radius:5px;padding:5px 9px;font-size:10px;color:#e2e8f0;pointer-events:none;z-index:50;display:none;max-width:300px}
.tooltip .tt-name{font-weight:600;color:#93c5fd}.tooltip .tt-info{color:#94a3b8;font-size:9px;margin-top:2px}
</style>
</head>
<body>
<div class="panel">
  <div class="panel-section">
    <div class="stats">
      <div class="stat-box"><div class="num" id="tblCount">67</div><div class="lbl">Tables</div></div>
      <div class="stat-box"><div class="num" id="relCount">0</div><div class="lbl">Relations</div></div>
    </div>
  </div>
  <div class="panel-section">
    <h3>Presets</h3>
    <div class="preset-grid" id="presets"></div>
  </div>
  <div class="panel-section">
    <h3>Domains</h3>
    <div class="check-group" id="domains"></div>
  </div>
  <div class="panel-section">
    <h3>Relationships</h3>
    <div class="rel-toggle">
      <label><input type="checkbox" checked onchange="state.showRealFK=this.checked;render()"><span style="color:#f472b6">Real FK</span></label>
      <label><input type="checkbox" checked onchange="state.showLogical=this.checked;render()"><span style="color:#475569">Logical</span></label>
    </div>
  </div>
  <div class="panel-section">
    <h3>Search</h3>
    <input class="search-box" id="search" placeholder="테이블/컬럼 검색..." oninput="state.search=this.value.toLowerCase();render()">
  </div>
  <div class="detail-area">
    <h3>Table Detail</h3>
    <div id="detailPanel"><p class="no-detail">테이블을 클릭하면 상세 정보가 표시됩니다</p></div>
  </div>
</div>
<div class="main">
  <div class="toolbar">
    <div class="title"><span>HANES MES</span> — ERD Explorer (67 Tables)</div>
    <button class="zoom-btn" onclick="zoom(-1)">−</button>
    <span class="zoom-label" id="zoomLabel">100%</span>
    <button class="zoom-btn" onclick="zoom(1)">+</button>
    <button class="zoom-btn" onclick="zoom(0)">⌂</button>
  </div>
  <div class="canvas-wrap" id="canvasWrap"><svg id="svg" xmlns="http://www.w3.org/2000/svg"></svg></div>
  <div class="prompt-area">
    <div class="prompt-header"><h3>Prompt</h3><button class="copy-btn" id="copyBtn" onclick="copyPrompt()">Copy</button></div>
    <div class="prompt-text" id="promptText"></div>
  </div>
</div>
<div class="tooltip" id="tooltip"><div class="tt-name"></div><div class="tt-info"></div></div>

<script>
/** @file HANES MES ERD Explorer — 67 tables interactive visualization */

const DOMAINS = {
  master:   { label:'기준정보 Master',   color:'#3b82f6', fill:'#172554', stroke:'#2563eb', bg:'rgba(59,130,246,.06)' },
  equip:    { label:'설비 Equipment',    color:'#10b981', fill:'#052e16', stroke:'#059669', bg:'rgba(16,185,129,.06)' },
  consum:   { label:'소모품 Consumable', color:'#14b8a6', fill:'#042f2e', stroke:'#0d9488', bg:'rgba(20,184,166,.06)' },
  material: { label:'자재 Material',     color:'#f59e0b', fill:'#451a03', stroke:'#d97706', bg:'rgba(245,158,11,.06)' },
  production:{label:'생산 Production',   color:'#8b5cf6', fill:'#2e1065', stroke:'#7c3aed', bg:'rgba(139,92,246,.06)' },
  quality:  { label:'품질 Quality',      color:'#ef4444', fill:'#450a0a', stroke:'#dc2626', bg:'rgba(239,68,68,.06)' },
  shipping: { label:'출하 Shipping',     color:'#06b6d4', fill:'#083344', stroke:'#0891b2', bg:'rgba(6,182,212,.06)' },
  subcon:   { label:'외주 Subcon',       color:'#ec4899', fill:'#500724', stroke:'#db2777', bg:'rgba(236,72,153,.06)' },
  customs:  { label:'보세 Customs',      color:'#f97316', fill:'#431407', stroke:'#ea580c', bg:'rgba(249,115,22,.06)' },
  system:   { label:'시스템 System',     color:'#6b7280', fill:'#1f2937', stroke:'#4b5563', bg:'rgba(107,114,128,.06)' },
};

const W=120, H=30, G=8;

// Table definitions: [id, tableName, domain, x, y, columns[{name,type,pk?,fk?,nullable?}]]
const tables = [
  // === Master Domain (x:20-760, y:30-190) ===
  { id:'part',       name:'PART_MASTERS',         domain:'master', x:20,  y:40,  cols:[{n:'id',pk:1},{n:'partCode',t:'varchar 50',u:1},{n:'partName',t:'varchar 100'},{n:'partType',t:'varchar 50'},{n:'productType'},{n:'spec'},{n:'unit',t:"'EA'"},{n:'leadTime'},{n:'safetyStock'},{n:'lotUnitQty'},{n:'boxQty'},{n:'iqcYn'},{n:'tactTime'},{n:'useYn'}]},
  { id:'partner',    name:'PARTNER_MASTERS',      domain:'master', x:160, y:40,  cols:[{n:'id',pk:1},{n:'partnerCode',u:1},{n:'partnerName'},{n:'partnerType'},{n:'bizNo'},{n:'ceoName'},{n:'tel'},{n:'email'},{n:'useYn'}]},
  { id:'vendor',     name:'VENDOR_MASTERS',       domain:'master', x:300, y:40,  cols:[{n:'id',pk:1},{n:'vendorCode',u:1},{n:'vendorName'},{n:'vendorType'},{n:'bizNo'},{n:'useYn'}]},
  { id:'company',    name:'COMPANY_MASTERS',      domain:'master', x:440, y:40,  cols:[{n:'id',pk:1},{n:'companyCode',u:1},{n:'companyName'},{n:'bizNo'},{n:'useYn'}]},
  { id:'dept',       name:'DEPARTMENT_MASTERS',   domain:'master', x:580, y:40,  cols:[{n:'id',pk:1},{n:'deptCode',u:1},{n:'deptName'},{n:'parentDeptCode'},{n:'useYn'}]},
  { id:'worker',     name:'WORKER_MASTERS',       domain:'master', x:720, y:40,  cols:[{n:'id',pk:1},{n:'workerCode',u:1},{n:'workerName'},{n:'dept'},{n:'processIds',t:'clob'},{n:'useYn'}]},
  { id:'process',    name:'PROCESS_MASTERS',      domain:'master', x:20,  y:80,  cols:[{n:'id',pk:1},{n:'processCode',u:1},{n:'processName'},{n:'processType'},{n:'sampleInspectYn'},{n:'useYn'}]},
  { id:'procmap',    name:'PROCESS_MAPS',         domain:'master', x:160, y:80,  cols:[{n:'id',pk:1},{n:'partId',fk:'part'},{n:'seq'},{n:'processCode'},{n:'equipType'},{n:'stdTime'},{n:'wireLength'},{n:'crimpHeight'}]},
  { id:'bom',        name:'BOM_MASTERS',          domain:'master', x:300, y:80,  cols:[{n:'id',pk:1},{n:'parentPartId',fk:'part'},{n:'childPartId',fk:'part'},{n:'qtyPer'},{n:'revision'},{n:'processCode'},{n:'useYn'}]},
  { id:'prodline',   name:'PROD_LINE_MASTERS',    domain:'master', x:440, y:80,  cols:[{n:'id',pk:1},{n:'lineCode',u:1},{n:'lineName'},{n:'lineType'},{n:'oper'},{n:'useYn'}]},
  { id:'plant',      name:'PLANTS',               domain:'master', x:580, y:80,  cols:[{n:'id',pk:1},{n:'plantCode'},{n:'shopCode'},{n:'lineCode'},{n:'parentId',fk:'plant'},{n:'useYn'}]},
  { id:'wh',         name:'WAREHOUSES',           domain:'master', x:720, y:80,  cols:[{n:'id',pk:1},{n:'warehouseCode',u:1},{n:'warehouseName'},{n:'warehouseType'},{n:'lineCode'},{n:'processCode'},{n:'isDefault'},{n:'useYn'}]},
  { id:'whloc',      name:'WAREHOUSE_LOCATIONS',  domain:'master', x:20,  y:120, cols:[{n:'id',pk:1},{n:'warehouseId',fk:'wh'},{n:'locationCode'},{n:'zone'},{n:'useYn'}]},
  { id:'whtrans',    name:'WH_TRANSFER_RULES',    domain:'master', x:160, y:120, cols:[{n:'id',pk:1},{n:'fromWarehouseId',fk:'wh'},{n:'toWarehouseId',fk:'wh'},{n:'allowYn'}]},
  { id:'numrule',    name:'NUM_RULE_MASTERS',     domain:'master', x:300, y:120, cols:[{n:'id',pk:1},{n:'ruleType',u:1},{n:'pattern'},{n:'prefix'},{n:'seqLength'},{n:'currentSeq'},{n:'resetType'}]},
  { id:'label',      name:'LABEL_TEMPLATES',      domain:'master', x:440, y:120, cols:[{n:'id',pk:1},{n:'templateName'},{n:'category'},{n:'designData',t:'clob'},{n:'isDefault'},{n:'useYn'}]},
  { id:'suffix',     name:'MODEL_SUFFIXES',       domain:'master', x:580, y:120, cols:[{n:'id',pk:1},{n:'modelCode'},{n:'suffixCode'},{n:'suffixName'},{n:'customer'}]},
  { id:'workinst',   name:'WORK_INSTRUCTIONS',    domain:'master', x:720, y:120, cols:[{n:'id',pk:1},{n:'partId',fk:'part'},{n:'processCode'},{n:'title'},{n:'content',t:'clob'},{n:'revision'}]},
  { id:'comcode',    name:'COM_CODES',            domain:'master', x:20,  y:160, cols:[{n:'id',pk:1},{n:'groupCode'},{n:'detailCode'},{n:'codeName'},{n:'sortOrder'},{n:'attr1'},{n:'attr2'},{n:'useYn'}]},
  { id:'vbarcode',   name:'VENDOR_BARCODE_MAP',   domain:'master', x:160, y:160, cols:[{n:'id',pk:1},{n:'vendorBarcode',u:1},{n:'partId',fk:'part'},{n:'vendorCode'},{n:'matchType'},{n:'useYn'}]},

  // === Equipment (x:860-1120, y:30-150) ===
  { id:'equip',      name:'EQUIP_MASTERS',        domain:'equip', x:870, y:40,  cols:[{n:'id',pk:1},{n:'equipCode',u:1},{n:'equipName'},{n:'equipType'},{n:'lineCode'},{n:'processCode'},{n:'ipAddress'},{n:'status'},{n:'useYn'}]},
  { id:'eqbomitem',  name:'EQUIP_BOM_ITEMS',      domain:'equip', x:1010,y:40,  cols:[{n:'id',pk:1},{n:'itemCode',u:1},{n:'itemName'},{n:'itemType'},{n:'unit'},{n:'replacementCycle'},{n:'stockQty'},{n:'safetyStock'}]},
  { id:'eqbomrel',   name:'EQUIP_BOM_RELS',       domain:'equip', x:870, y:80,  cols:[{n:'id',pk:1},{n:'equipId',fk:'equip',r:1},{n:'bomItemId',fk:'eqbomitem',r:1},{n:'quantity'},{n:'installDate'},{n:'expireDate'}]},
  { id:'eqinspitem', name:'EQUIP_INSPECT_ITEMS',  domain:'equip', x:1010,y:80,  cols:[{n:'id',pk:1},{n:'equipId',fk:'equip'},{n:'inspectType'},{n:'seq'},{n:'itemName'},{n:'criteria'},{n:'useYn'}]},
  { id:'eqinsplog',  name:'EQUIP_INSPECT_LOGS',   domain:'equip', x:870, y:120, cols:[{n:'id',pk:1},{n:'equipId',fk:'equip'},{n:'inspectType'},{n:'inspectDate'},{n:'overallResult'},{n:'details',t:'clob'}]},

  // === Consumables (x:1150-1300, y:30-100) ===
  { id:'consumable', name:'CONSUMABLE_MASTERS',   domain:'consum', x:1160,y:40,  cols:[{n:'id',pk:1},{n:'consumableCode',u:1},{n:'consumableName'},{n:'category'},{n:'expectedLife'},{n:'currentCount'},{n:'stockQty'},{n:'status'}]},
  { id:'consumlog',  name:'CONSUMABLE_LOGS',      domain:'consum', x:1160,y:80,  cols:[{n:'id',pk:1},{n:'consumableId',fk:'consumable'},{n:'logType'},{n:'qty'},{n:'workerId'},{n:'equipId'}]},

  // === Material (x:20-560, y:210-410) ===
  { id:'po',         name:'PURCHASE_ORDERS',      domain:'material', x:20,  y:220, cols:[{n:'id',pk:1},{n:'poNo',u:1},{n:'partnerId',fk:'partner'},{n:'orderDate'},{n:'dueDate'},{n:'status'},{n:'totalAmount'}]},
  { id:'poitem',     name:'PO_ITEMS',             domain:'material', x:160, y:220, cols:[{n:'id',pk:1},{n:'poId',fk:'po'},{n:'partId',fk:'part'},{n:'orderQty'},{n:'receivedQty'},{n:'unitPrice'}]},
  { id:'lot',        name:'LOTS',                 domain:'material', x:300, y:220, cols:[{n:'id',pk:1},{n:'lotNo',u:1},{n:'partId',fk:'part'},{n:'partType'},{n:'initQty'},{n:'currentQty'},{n:'iqcStatus'},{n:'status'},{n:'poNo'},{n:'jobOrderId'}]},
  { id:'matlot',     name:'MAT_LOTS',             domain:'material', x:440, y:220, cols:[{n:'id',pk:1},{n:'lotNo',u:1},{n:'partId',fk:'part'},{n:'initQty'},{n:'currentQty'},{n:'iqcStatus'},{n:'status'},{n:'poNo'}]},
  { id:'matstock',   name:'MAT_STOCKS',           domain:'material', x:20,  y:260, cols:[{n:'id',pk:1},{n:'warehouseCode',fk:'wh'},{n:'partId',fk:'part'},{n:'lotId',fk:'matlot'},{n:'qty'},{n:'reservedQty'},{n:'availableQty'}]},
  { id:'stock',      name:'STOCKS',               domain:'material', x:160, y:260, cols:[{n:'id',pk:1},{n:'warehouseId',fk:'wh'},{n:'partId',fk:'part'},{n:'lotId',fk:'lot'},{n:'qty'},{n:'reservedQty'},{n:'availableQty'}]},
  { id:'stktrans',   name:'STOCK_TRANSACTIONS',   domain:'material', x:300, y:260, cols:[{n:'id',pk:1},{n:'transNo',u:1},{n:'transType'},{n:'fromWarehouseId',fk:'wh'},{n:'toWarehouseId',fk:'wh'},{n:'partId',fk:'part'},{n:'lotId'},{n:'qty'},{n:'status'}]},
  { id:'invadj',     name:'INV_ADJ_LOGS',         domain:'material', x:440, y:260, cols:[{n:'id',pk:1},{n:'warehouseCode',fk:'wh'},{n:'partId',fk:'part'},{n:'lotId'},{n:'adjType'},{n:'beforeQty'},{n:'afterQty'},{n:'diffQty'}]},
  { id:'matissue',   name:'MAT_ISSUES',           domain:'material', x:20,  y:300, cols:[{n:'id',pk:1},{n:'jobOrderId',fk:'joborder'},{n:'lotId',fk:'lot'},{n:'issueQty'},{n:'issueType'},{n:'workerId'},{n:'status'}]},
  { id:'matreq',     name:'MAT_ISSUE_REQUESTS',   domain:'material', x:160, y:300, cols:[{n:'id',pk:1},{n:'requestNo',u:1},{n:'jobOrderId',fk:'joborder'},{n:'status'},{n:'requester'},{n:'approver'}]},
  { id:'matreqitem', name:'MAT_ISSUE_REQ_ITEMS',  domain:'material', x:300, y:300, cols:[{n:'id',pk:1},{n:'requestId',fk:'matreq'},{n:'partId',fk:'part'},{n:'requestQty'},{n:'issuedQty'}]},

  // === Production (x:580-780, y:210-350) ===
  { id:'joborder',   name:'JOB_ORDERS',           domain:'production', x:600, y:220, cols:[{n:'id',pk:1},{n:'orderNo',u:1},{n:'parentId',fk:'joborder',r:1},{n:'partId',fk:'part',r:1},{n:'lineCode'},{n:'planQty'},{n:'goodQty'},{n:'defectQty'},{n:'planDate'},{n:'status'},{n:'erpSyncYn'}]},
  { id:'prodresult', name:'PROD_RESULTS',         domain:'production', x:600, y:268, cols:[{n:'id',pk:1},{n:'jobOrderId',fk:'joborder',r:1},{n:'equipId',fk:'equip'},{n:'workerId'},{n:'lotNo'},{n:'processCode'},{n:'goodQty'},{n:'defectQty'},{n:'cycleTime'},{n:'status'}]},
  { id:'sampleinsp', name:'SAMPLE_INSPECT_RESULTS',domain:'production',x:600, y:316, cols:[{n:'id',pk:1},{n:'jobOrderId',fk:'joborder',r:1},{n:'inspectDate'},{n:'inspectorName'},{n:'sampleNo'},{n:'measuredValue'},{n:'specUpper'},{n:'specLower'},{n:'passYn'}]},

  // === Quality (x:780-1160, y:210-370) ===
  { id:'iqclog',     name:'IQC_LOGS',             domain:'quality', x:790, y:220, cols:[{n:'id',pk:1},{n:'lotId'},{n:'lotNo'},{n:'partId',fk:'part'},{n:'inspectType'},{n:'result'},{n:'inspectorName'},{n:'inspectDate'}]},
  { id:'iqcitem',    name:'IQC_ITEM_MASTERS',     domain:'quality', x:930, y:220, cols:[{n:'id',pk:1},{n:'partId',fk:'part'},{n:'seq'},{n:'inspectItem'},{n:'lsl'},{n:'usl'},{n:'unit'},{n:'isShelfLife'},{n:'useYn'}]},
  { id:'iqcgroup',   name:'IQC_GROUPS',           domain:'quality', x:1070,y:220, cols:[{n:'id',pk:1},{n:'groupCode',u:1},{n:'groupName'},{n:'inspectMethod'},{n:'sampleQty'},{n:'useYn'}]},
  { id:'iqcgitem',   name:'IQC_GROUP_ITEMS',      domain:'quality', x:1070,y:260, cols:[{n:'id',pk:1},{n:'groupId',fk:'iqcgroup',r:1},{n:'itemId'},{n:'seq'}]},
  { id:'iqcplink',   name:'IQC_PART_LINKS',       domain:'quality', x:930, y:260, cols:[{n:'id',pk:1},{n:'partId',fk:'part',r:1},{n:'partnerId',fk:'partner',r:1},{n:'groupId',fk:'iqcgroup',r:1},{n:'useYn'}]},
  { id:'inspresult', name:'INSPECT_RESULTS',      domain:'quality', x:790, y:300, cols:[{n:'id',pk:1},{n:'prodResultId',fk:'prodresult',r:1},{n:'serialNo'},{n:'inspectType'},{n:'passYn'},{n:'errorCode'},{n:'inspectData',t:'clob'}]},
  { id:'defectlog',  name:'DEFECT_LOGS',          domain:'quality', x:930, y:300, cols:[{n:'id',pk:1},{n:'prodResultId',fk:'prodresult',r:1},{n:'defectCode'},{n:'defectName'},{n:'qty'},{n:'status'},{n:'cause'}]},
  { id:'repairlog',  name:'REPAIR_LOGS',          domain:'quality', x:1070,y:300, cols:[{n:'id',pk:1},{n:'defectLogId',fk:'defectlog'},{n:'workerId'},{n:'repairAction'},{n:'result'}]},

  // === Shipping (x:20-560, y:360-500) ===
  { id:'custorder',  name:'CUSTOMER_ORDERS',      domain:'shipping', x:20,  y:380, cols:[{n:'id',pk:1},{n:'orderNo',u:1},{n:'customerId'},{n:'customerName'},{n:'orderDate'},{n:'dueDate'},{n:'status'},{n:'totalAmount'}]},
  { id:'custitem',   name:'CUSTOMER_ORDER_ITEMS',  domain:'shipping', x:160, y:380, cols:[{n:'id',pk:1},{n:'orderId',fk:'custorder'},{n:'partId',fk:'part'},{n:'orderQty'},{n:'shippedQty'},{n:'unitPrice'}]},
  { id:'shiporder',  name:'SHIPMENT_ORDERS',      domain:'shipping', x:300, y:380, cols:[{n:'id',pk:1},{n:'shipOrderNo',u:1},{n:'customerId'},{n:'dueDate'},{n:'shipDate'},{n:'status'}]},
  { id:'shipitem',   name:'SHIPMENT_ORDER_ITEMS', domain:'shipping', x:440, y:380, cols:[{n:'id',pk:1},{n:'shipOrderId',fk:'shiporder'},{n:'partId',fk:'part'},{n:'orderQty'},{n:'shippedQty'}]},
  { id:'shiplog',    name:'SHIPMENT_LOGS',        domain:'shipping', x:20,  y:420, cols:[{n:'id',pk:1},{n:'shipNo',u:1},{n:'shipDate'},{n:'vehicleNo'},{n:'customer'},{n:'palletCount'},{n:'boxCount'},{n:'totalQty'},{n:'status'},{n:'erpSyncYn'}]},
  { id:'shipreturn', name:'SHIPMENT_RETURNS',     domain:'shipping', x:160, y:420, cols:[{n:'id',pk:1},{n:'returnNo',u:1},{n:'shipmentId',fk:'shiplog'},{n:'returnDate'},{n:'returnReason'},{n:'status'}]},
  { id:'shipretitem',name:'SHIP_RETURN_ITEMS',    domain:'shipping', x:300, y:420, cols:[{n:'id',pk:1},{n:'returnId',fk:'shipreturn'},{n:'partId',fk:'part'},{n:'returnQty'},{n:'disposalType'}]},
  { id:'box',        name:'BOX_MASTERS',          domain:'shipping', x:440, y:420, cols:[{n:'id',pk:1},{n:'boxNo',u:1},{n:'partId',fk:'part'},{n:'qty'},{n:'palletId',fk:'pallet'},{n:'status'}]},
  { id:'pallet',     name:'PALLET_MASTERS',       domain:'shipping', x:440, y:460, cols:[{n:'id',pk:1},{n:'palletNo',u:1},{n:'boxCount'},{n:'totalQty'},{n:'status'},{n:'shipmentId',fk:'shiplog'}]},

  // === Subcontracting (x:600-820, y:380-470) ===
  { id:'suborder',   name:'SUBCON_ORDERS',        domain:'subcon', x:600, y:380, cols:[{n:'id',pk:1},{n:'orderNo',u:1},{n:'vendorId',fk:'vendor'},{n:'partCode'},{n:'orderQty'},{n:'deliveredQty'},{n:'receivedQty'},{n:'status'}]},
  { id:'subdel',     name:'SUBCON_DELIVERIES',    domain:'subcon', x:600, y:420, cols:[{n:'id',pk:1},{n:'orderId',fk:'suborder'},{n:'deliveryNo',u:1},{n:'lotNo'},{n:'qty'},{n:'status'}]},
  { id:'subrecv',    name:'SUBCON_RECEIVES',      domain:'subcon', x:600, y:460, cols:[{n:'id',pk:1},{n:'orderId',fk:'suborder'},{n:'receiveNo',u:1},{n:'qty'},{n:'goodQty'},{n:'defectQty'},{n:'inspectResult'}]},

  // === Customs (x:800-1020, y:380-470) ===
  { id:'cusentry',   name:'CUSTOMS_ENTRIES',      domain:'customs', x:790, y:380, cols:[{n:'id',pk:1},{n:'entryNo',u:1},{n:'blNo'},{n:'invoiceNo'},{n:'declarationDate'},{n:'hsCode'},{n:'totalAmount'},{n:'status'}]},
  { id:'cuslot',     name:'CUSTOMS_LOTS',         domain:'customs', x:790, y:420, cols:[{n:'id',pk:1},{n:'entryId',fk:'cusentry'},{n:'lotNo'},{n:'partCode'},{n:'qty'},{n:'usedQty'},{n:'remainQty'},{n:'status'}]},
  { id:'cususage',   name:'CUSTOMS_USAGE_REPORTS',domain:'customs', x:790, y:460, cols:[{n:'id',pk:1},{n:'reportNo',u:1},{n:'customsLotId',fk:'cuslot'},{n:'jobOrderId',fk:'joborder'},{n:'usageQty'},{n:'status'}]},

  // === System (x:980-1280, y:380-500) ===
  { id:'user',       name:'USERS',                domain:'system', x:980, y:380, cols:[{n:'id',pk:1},{n:'email',u:1},{n:'password'},{n:'name'},{n:'empNo'},{n:'dept'},{n:'role'},{n:'status'},{n:'photoUrl'}]},
  { id:'userauth',   name:'USER_AUTHS',           domain:'system', x:1120,y:380, cols:[{n:'id',pk:1},{n:'userId',fk:'user'},{n:'menuCode'},{n:'canRead'},{n:'canWrite'},{n:'canDelete'},{n:'canExport'}]},
  { id:'commcfg',    name:'COMM_CONFIGS',         domain:'system', x:980, y:420, cols:[{n:'id',pk:1},{n:'configName',u:1},{n:'commType'},{n:'host'},{n:'port'},{n:'baudRate'},{n:'useYn'}]},
  { id:'syscfg',     name:'SYS_CONFIGS',          domain:'system', x:1120,y:420, cols:[{n:'id',pk:1},{n:'configGroup'},{n:'configKey'},{n:'configValue'},{n:'configType'},{n:'label'},{n:'isActive'}]},
  { id:'interlog',   name:'INTER_LOGS',           domain:'system', x:980, y:460, cols:[{n:'id',pk:1},{n:'direction'},{n:'messageType'},{n:'payload',t:'clob'},{n:'status'},{n:'retryCount'}]},
  { id:'tracelog',   name:'TRACE_LOGS',           domain:'system', x:1120,y:460, cols:[{n:'id',pk:1},{n:'palletId'},{n:'boxId'},{n:'lotId'},{n:'equipId'},{n:'workerId'},{n:'processCode'},{n:'serialNo'},{n:'eventType'}]},
];

// Relations: [fromTable, fromCol, toTable, real=true/false]
const relations = [
  // Real FK (TypeORM decorator)
  ['eqbomrel','equipId','equip',true],['eqbomrel','bomItemId','eqbomitem',true],
  ['iqcgitem','groupId','iqcgroup',true],
  ['iqcplink','partId','part',true],['iqcplink','partnerId','partner',true],['iqcplink','groupId','iqcgroup',true],
  ['joborder','parentId','joborder',true],['joborder','partId','part',true],
  ['prodresult','jobOrderId','joborder',true],
  ['inspresult','prodResultId','prodresult',true],
  ['defectlog','prodResultId','prodresult',true],
  ['sampleinsp','jobOrderId','joborder',true],
  ['plant','parentId','plant',true],
  // Logical FK
  ['bom','parentPartId','part',false],['bom','childPartId','part',false],
  ['procmap','partId','part',false],
  ['workinst','partId','part',false],
  ['vbarcode','partId','part',false],
  ['eqinspitem','equipId','equip',false],['eqinsplog','equipId','equip',false],
  ['consumlog','consumableId','consumable',false],
  ['po','partnerId','partner',false],
  ['poitem','poId','po',false],['poitem','partId','part',false],
  ['lot','partId','part',false],['matlot','partId','part',false],
  ['matstock','warehouseCode','wh',false],['matstock','partId','part',false],
  ['stock','warehouseId','wh',false],['stock','partId','part',false],
  ['stktrans','partId','part',false],['stktrans','fromWarehouseId','wh',false],
  ['invadj','warehouseCode','wh',false],['invadj','partId','part',false],
  ['matissue','jobOrderId','joborder',false],['matissue','lotId','lot',false],
  ['matreq','jobOrderId','joborder',false],
  ['matreqitem','requestId','matreq',false],['matreqitem','partId','part',false],
  ['prodresult','equipId','equip',false],
  ['iqclog','partId','part',false],['iqcitem','partId','part',false],
  ['repairlog','defectLogId','defectlog',false],
  ['custitem','orderId','custorder',false],['custitem','partId','part',false],
  ['shipitem','shipOrderId','shiporder',false],['shipitem','partId','part',false],
  ['shipreturn','shipmentId','shiplog',false],
  ['shipretitem','returnId','shipreturn',false],['shipretitem','partId','part',false],
  ['box','partId','part',false],['box','palletId','pallet',false],
  ['pallet','shipmentId','shiplog',false],
  ['suborder','vendorId','vendor',false],
  ['subdel','orderId','suborder',false],['subrecv','orderId','suborder',false],
  ['cusentry','entryId','cusentry',false],
  ['cuslot','entryId','cusentry',false],['cususage','customsLotId','cuslot',false],['cususage','jobOrderId','joborder',false],
  ['userauth','userId','user',false],
  ['whloc','warehouseId','wh',false],['whtrans','fromWarehouseId','wh',false],
];

const PRESETS = {
  '전체':        { domains: Object.keys(DOMAINS) },
  '기준정보':    { domains:['master'] },
  '자재+구매':   { domains:['master','material'] },
  '생산+품질':   { domains:['production','quality','master'] },
  '출하':        { domains:['shipping','master'] },
  '설비+소모품': { domains:['equip','consum','master'] },
  '외주+보세':   { domains:['subcon','customs','master'] },
  '시스템':      { domains:['system'] },
};

/* State */
const state = { domains:{}, showRealFK:true, showLogical:true, search:'', zoom:1, panX:0, panY:0, preset:'전체', selected:null, drag:false, dx:0, dy:0, dpx:0, dpy:0 };
Object.keys(DOMAINS).forEach(k=>state.domains[k]=true);

const svg=document.getElementById('svg'), wrap=document.getElementById('canvasWrap');

function render(){
  const vw=1340, vh=540;
  svg.setAttribute('viewBox',`${-state.panX/state.zoom} ${-state.panY/state.zoom} ${vw/state.zoom} ${vh/state.zoom}`);

  const visTables = tables.filter(t=>state.domains[t.domain] && (!state.search || t.name.toLowerCase().includes(state.search) || t.cols.some(c=>c.n.toLowerCase().includes(state.search))));
  const visIds = new Set(visTables.map(t=>t.id));

  let h='<defs><marker id="ak-real" markerWidth="6" markerHeight="5" refX="5" refY="2.5" orient="auto"><polygon points="0 0,6 2.5,0 5" fill="#f472b6" opacity=".8"/></marker>';
  h+='<marker id="ak-log" markerWidth="6" markerHeight="5" refX="5" refY="2.5" orient="auto"><polygon points="0 0,6 2.5,0 5" fill="#475569" opacity=".6"/></marker></defs>';

  // Domain backgrounds
  const domainBounds = {};
  visTables.forEach(t=>{
    if(!domainBounds[t.domain]) domainBounds[t.domain]={x1:t.x,y1:t.y,x2:t.x+W,y2:t.y+H};
    const b=domainBounds[t.domain];
    b.x1=Math.min(b.x1,t.x); b.y1=Math.min(b.y1,t.y);
    b.x2=Math.max(b.x2,t.x+W); b.y2=Math.max(b.y2,t.y+H);
  });
  Object.entries(domainBounds).forEach(([k,b])=>{
    const d=DOMAINS[k]; const pad=10;
    h+=`<rect x="${b.x1-pad}" y="${b.y1-pad}" width="${b.x2-b.x1+pad*2}" height="${b.y2-b.y1+pad*2}" rx="6" fill="${d.bg}" stroke="${d.stroke}" stroke-width=".5" stroke-dasharray="4,3" opacity=".8"/>`;
    h+=`<text x="${b.x1-pad+4}" y="${b.y1-pad+9}" fill="${d.color}" font-size="7" opacity=".6">${d.label}</text>`;
  });

  // Relations
  let visRelCount=0;
  relations.forEach(([fromId,,toId,real])=>{
    if(real && !state.showRealFK) return;
    if(!real && !state.showLogical) return;
    if(!visIds.has(fromId) || !visIds.has(toId)) return;
    const f=tables.find(t=>t.id===fromId), t2=tables.find(t=>t.id===toId);
    if(!f||!t2) return;
    visRelCount++;
    const isSelf = fromId===toId;
    if(isSelf){
      h+=`<path d="M${f.x+W},${f.y+H/2} C${f.x+W+30},${f.y+H/2} ${f.x+W+30},${f.y-15} ${f.x+W/2},${f.y}" fill="none" stroke="${real?'#f472b6':'#475569'}" stroke-width="${real?1.2:.8}" opacity="${real?.6:.3}" stroke-dasharray="${real?'':'3,3'}" marker-end="url(#ak-${real?'real':'log'})"/>`;
      return;
    }
    let x1,y1,x2,y2;
    const dx=t2.x-f.x, dy=t2.y-f.y;
    if(Math.abs(dy)<5){x1=dx>0?f.x+W:f.x;y1=f.y+H/2;x2=dx>0?t2.x:t2.x+W;y2=t2.y+H/2;const mx=(x1+x2)/2;h+=`<path d="M${x1},${y1} C${mx},${y1} ${mx},${y2} ${x2},${y2}" fill="none" stroke="${real?'#f472b6':'#475569'}" stroke-width="${real?1.2:.8}" opacity="${real?.6:.25}" stroke-dasharray="${real?'':'3,3'}" marker-end="url(#ak-${real?'real':'log'})"/>`;
    } else {
      x1=f.x+W/2; y1=dy>0?f.y+H:f.y; x2=t2.x+W/2; y2=dy>0?t2.y:t2.y+H;
      const cy1=y1+(y2-y1)*.4, cy2=y2-(y2-y1)*.4;
      const hl=state.selected&&(state.selected===fromId||state.selected===toId);
      h+=`<path d="M${x1},${y1} C${x1},${cy1} ${x2},${cy2} ${x2},${y2}" fill="none" stroke="${real?'#f472b6':'#475569'}" stroke-width="${hl?2:real?1.2:.8}" opacity="${hl?1:real?.6:.25}" stroke-dasharray="${real?'':'3,3'}" marker-end="url(#ak-${real?'real':'log'})"/>`;
    }
  });

  // Tables
  visTables.forEach(t=>{
    const d=DOMAINS[t.domain], isSel=state.selected===t.id;
    const matched = state.search && (t.name.toLowerCase().includes(state.search) || t.cols.some(c=>c.n.toLowerCase().includes(state.search)));
    const op = state.search ? (matched?1:.2) : 1;
    h+=`<g style="cursor:pointer;opacity:${op}" onclick="selectTable('${t.id}')" onmouseenter="showTip(event,'${t.id}')" onmouseleave="hideTip()">`;
    h+=`<rect x="${t.x}" y="${t.y}" width="${W}" height="${H}" rx="4" fill="${d.fill}" stroke="${isSel?'#fbbf24':d.stroke}" stroke-width="${isSel?2:.8}"/>`;
    h+=`<text x="${t.x+W/2}" y="${t.y+12}" text-anchor="middle" fill="${d.color}" font-size="7.5" font-weight="600">${t.name.replace('_MASTERS','').replace('_MASTER','')}</text>`;
    const fkCount=t.cols.filter(c=>c.fk).length;
    h+=`<text x="${t.x+W/2}" y="${t.y+22}" text-anchor="middle" fill="#64748b" font-size="6.5">${t.cols.length} cols${fkCount?' · '+fkCount+' FK':''}</text>`;
    h+=`</g>`;
  });

  svg.innerHTML=h;
  document.getElementById('relCount').textContent=visRelCount;
  document.getElementById('tblCount').textContent=visTables.length;
  updatePrompt();
}

/* Controls */
function buildControls(){
  document.getElementById('presets').innerHTML=Object.keys(PRESETS).map(k=>`<button class="preset-btn${state.preset===k?' active':''}" onclick="applyPreset('${k}')">${k}</button>`).join('');
  document.getElementById('domains').innerHTML=Object.entries(DOMAINS).map(([k,v])=>{
    const cnt=tables.filter(t=>t.domain===k).length;
    return `<label class="check-item"><input type="checkbox" ${state.domains[k]?'checked':''} onchange="toggleD('${k}',this.checked)"><span class="color-dot" style="background:${v.color}"></span>${v.label}<span class="tbl-count">${cnt}</span></label>`;
  }).join('');
}
function applyPreset(n){const p=PRESETS[n];state.preset=n;Object.keys(DOMAINS).forEach(k=>state.domains[k]=p.domains.includes(k));state.selected=null;buildControls();render();}
function toggleD(k,v){state.domains[k]=v;state.preset='';buildControls();render();}

/* Zoom & Pan */
function zoom(d){if(d===0){state.zoom=1;state.panX=0;state.panY=0;}else state.zoom=Math.max(.3,Math.min(4,state.zoom+d*.2));document.getElementById('zoomLabel').textContent=Math.round(state.zoom*100)+'%';render();}
wrap.addEventListener('wheel',e=>{e.preventDefault();zoom(e.deltaY<0?1:-1);},{passive:false});
wrap.addEventListener('mousedown',e=>{if(e.target.closest('g'))return;state.drag=true;state.dx=e.clientX;state.dy=e.clientY;state.dpx=state.panX;state.dpy=state.panY;wrap.style.cursor='grabbing';});
window.addEventListener('mousemove',e=>{if(!state.drag)return;state.panX=state.dpx+(e.clientX-state.dx);state.panY=state.dpy+(e.clientY-state.dy);render();});
window.addEventListener('mouseup',()=>{state.drag=false;wrap.style.cursor='';});

/* Tooltip */
const tip=document.getElementById('tooltip');
function showTip(e,id){const t=tables.find(x=>x.id===id);if(!t)return;tip.querySelector('.tt-name').textContent=t.name;const fks=t.cols.filter(c=>c.fk).map(c=>`${c.n} → ${c.fk.toUpperCase()}`);tip.querySelector('.tt-info').textContent=`${t.cols.length} columns${fks.length?' | FK: '+fks.join(', '):''}`;tip.style.display='block';tip.style.left=(e.clientX+12)+'px';tip.style.top=(e.clientY-8)+'px';}
function hideTip(){tip.style.display='none';}

/* Select Table — show detail */
function selectTable(id){
  state.selected=id;render();
  const t=tables.find(x=>x.id===id);if(!t)return;
  const d=DOMAINS[t.domain];
  let html=`<div class="detail-card"><div class="dt-name">${t.name}</div><div class="dt-domain" style="color:${d.color}">${d.label}</div><div class="col-list">`;
  t.cols.forEach(c=>{
    let badges='';
    if(c.pk) badges+='<span class="col-pk">PK</span> ';
    if(c.fk) badges+=`<span class="col-fk">FK→${c.fk}</span> `;
    if(c.u) badges+='<span class="col-fk" style="color:#f59e0b">UQ</span> ';
    if(c.r) badges+='<span class="col-fk" style="color:#10b981">REL</span> ';
    html+=`<div class="col-row">${badges}<span class="col-name">${c.n}</span><span class="col-type">${c.t||''}</span></div>`;
  });
  // Show related tables
  const rels=relations.filter(r=>r[0]===id||r[2]===id);
  if(rels.length){
    html+=`</div><div style="margin-top:8px;border-top:1px solid #334155;padding-top:6px"><div style="font-size:9px;color:#94a3b8;margin-bottom:4px">관계 (${rels.length})</div>`;
    rels.forEach(([from,col,to,real])=>{
      const dir=from===id?'→':'←';const other=from===id?to:from;
      const otherT=tables.find(x=>x.id===other);
      html+=`<div style="font-size:9px;color:${real?'#f472b6':'#475569'};margin-bottom:2px">${dir} ${otherT?otherT.name:other} ${real?'(FK)':'(logical)'}</div>`;
    });
  }
  html+=`</div></div>`;
  document.getElementById('detailPanel').innerHTML=html;
}

/* Prompt */
function updatePrompt(){
  const vis=Object.entries(state.domains).filter(([,v])=>v).map(([k])=>DOMAINS[k].label);
  let t=`HANES MES ERD — ${state.preset||'Custom'}\n도메인: ${vis.join(', ')}\n`;
  if(state.selected){const tbl=tables.find(x=>x.id===state.selected);if(tbl){t+=`\n선택: ${tbl.name} (${tbl.cols.length} columns)\n`;const fks=relations.filter(r=>r[0]===state.selected||r[2]===state.selected);if(fks.length)t+=`관계: ${fks.map(([f,c,to,r])=>`${f===state.selected?'→':'←'} ${to} ${r?'(FK)':'(logical)'}`).join(', ')}\n`;}}
  document.getElementById('promptText').textContent=t;
}
function copyPrompt(){const t=document.getElementById('promptText').textContent;navigator.clipboard.writeText(t);const b=document.getElementById('copyBtn');b.textContent='Copied!';b.classList.add('copied');setTimeout(()=>{b.textContent='Copy';b.classList.remove('copied');},1500);}

buildControls();render();
</script>
</body>
</html>
