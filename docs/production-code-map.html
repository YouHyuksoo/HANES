<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HANES MES — Production Flow Explorer</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:system-ui,-apple-system,sans-serif;background:#0f172a;color:#e2e8f0;display:flex;height:100vh;overflow:hidden}

/* Panel */
.panel{width:290px;min-width:260px;background:#1e293b;border-right:1px solid #334155;display:flex;flex-direction:column;overflow:hidden}
.panel-section{padding:10px 12px;border-bottom:1px solid #334155}
.panel-section h3{font-size:10px;text-transform:uppercase;letter-spacing:.7px;color:#94a3b8;margin-bottom:6px}
.preset-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px}
.preset-btn{padding:5px 6px;border:1px solid #475569;border-radius:5px;background:#1e293b;color:#cbd5e1;font-size:10px;cursor:pointer;transition:.15s;text-align:center}
.preset-btn:hover{border-color:#60a5fa;color:#93c5fd}
.preset-btn.active{background:#1e3a5f;border-color:#3b82f6;color:#93c5fd}
.check-group{display:flex;flex-direction:column;gap:3px}
.check-item{display:flex;align-items:center;gap:5px;font-size:11px;cursor:pointer;padding:1px 0}
.check-item input{accent-color:#3b82f6;cursor:pointer}
.color-dot{width:9px;height:9px;border-radius:50%;display:inline-block}
.line-sample{width:18px;height:2px;display:inline-block;border-radius:1px}

/* State Diagram in panel */
.state-diagram{padding:10px 12px;border-bottom:1px solid #334155}
.state-diagram h3{font-size:10px;text-transform:uppercase;letter-spacing:.7px;color:#94a3b8;margin-bottom:6px}
.state-flow{font-family:'Cascadia Code','Fira Code',monospace;font-size:9px;color:#64748b;line-height:1.6;white-space:pre}
.state-flow .s-wait{color:#94a3b8}.state-flow .s-run{color:#3b82f6}.state-flow .s-pause{color:#f59e0b}
.state-flow .s-done{color:#10b981}.state-flow .s-cancel{color:#ef4444}

/* Comments */
.comments-area{flex:1;overflow-y:auto;padding:8px 12px}
.comments-area h3{font-size:10px;text-transform:uppercase;letter-spacing:.7px;color:#94a3b8;margin-bottom:6px}
.comment-item{background:#0f172a;border:1px solid #334155;border-radius:5px;padding:7px 9px;margin-bottom:5px;font-size:10px;position:relative}
.comment-item .target{color:#60a5fa;font-weight:600}.comment-item .file{color:#64748b;font-size:9px}
.comment-item .text{color:#cbd5e1;margin-top:3px}.comment-item .del-btn{position:absolute;top:5px;right:7px;background:none;border:none;color:#64748b;cursor:pointer;font-size:13px}
.comment-item .del-btn:hover{color:#f87171}
.no-comments{color:#64748b;font-size:11px;font-style:italic}

/* Main */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden}
.toolbar{display:flex;align-items:center;gap:8px;padding:7px 12px;background:#1e293b;border-bottom:1px solid #334155}
.toolbar .title{font-size:13px;font-weight:700;color:#f1f5f9;flex:1}.toolbar .title span{color:#fbbf24}
.zoom-btn{width:26px;height:26px;border:1px solid #475569;border-radius:5px;background:#1e293b;color:#cbd5e1;cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center}
.zoom-btn:hover{border-color:#60a5fa;color:#93c5fd}
.zoom-label{font-size:10px;color:#64748b;min-width:36px;text-align:center}
.ep-badge{font-size:9px;background:#1e3a5f;color:#93c5fd;padding:2px 6px;border-radius:10px;margin-left:4px}

/* Canvas */
.canvas-wrap{flex:1;position:relative;overflow:hidden;background:#0f172a}
.canvas-wrap svg{width:100%;height:100%}
.legend{position:absolute;bottom:8px;left:8px;background:rgba(30,41,59,.94);border:1px solid #334155;border-radius:7px;padding:8px 12px;max-width:200px}
.legend h4{font-size:9px;text-transform:uppercase;letter-spacing:.5px;color:#64748b;margin-bottom:5px}
.legend-row{display:flex;align-items:center;gap:5px;font-size:10px;color:#94a3b8;margin-bottom:2px}

/* Prompt */
.prompt-area{background:#1e293b;border-top:1px solid #334155;padding:8px 12px;max-height:140px;overflow-y:auto}
.prompt-area .prompt-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px}
.prompt-area h3{font-size:10px;text-transform:uppercase;letter-spacing:.7px;color:#94a3b8}
.copy-btn{padding:3px 10px;border:1px solid #475569;border-radius:5px;background:#1e293b;color:#cbd5e1;cursor:pointer;font-size:10px}
.copy-btn:hover{border-color:#10b981;color:#6ee7b7}
.copy-btn.copied{border-color:#10b981;color:#10b981}
.prompt-text{font-family:'Cascadia Code','Fira Code',monospace;font-size:10px;color:#94a3b8;white-space:pre-wrap;line-height:1.5}

/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:100}
.modal-overlay.show{display:flex}
.modal{background:#1e293b;border:1px solid #475569;border-radius:10px;padding:16px;width:380px;max-width:90vw}
.modal h3{font-size:13px;color:#f1f5f9;margin-bottom:3px}
.modal .modal-file{font-size:10px;color:#64748b;margin-bottom:10px}
.modal textarea{width:100%;height:72px;background:#0f172a;border:1px solid #475569;border-radius:5px;color:#e2e8f0;padding:7px;font-size:11px;font-family:system-ui;resize:vertical}
.modal textarea:focus{outline:none;border-color:#3b82f6}
.modal-actions{display:flex;gap:6px;justify-content:flex-end;margin-top:10px}
.modal-actions button{padding:5px 14px;border-radius:5px;font-size:11px;cursor:pointer;border:1px solid #475569}
.modal-actions .cancel{background:transparent;color:#94a3b8}
.modal-actions .save{background:#3b82f6;border-color:#3b82f6;color:#fff}
.modal-actions .save:hover{background:#2563eb}

/* Tooltip */
.tooltip{position:fixed;background:#334155;border:1px solid #475569;border-radius:5px;padding:5px 9px;font-size:10px;color:#e2e8f0;pointer-events:none;z-index:50;display:none;max-width:320px}
.tooltip .tt-label{font-weight:600;color:#93c5fd}.tooltip .tt-file{color:#64748b;font-size:9px}
.tooltip .tt-detail{color:#94a3b8;margin-top:2px;font-size:9px;line-height:1.4}
.tooltip .tt-endpoints{color:#fbbf24;margin-top:3px;font-size:9px}
</style>
</head>
<body>

<!-- Left Panel -->
<div class="panel">
  <div class="panel-section">
    <h3>View Presets</h3>
    <div class="preset-grid" id="presets"></div>
  </div>
  <div class="panel-section">
    <h3>Layers</h3>
    <div class="check-group" id="layers"></div>
  </div>
  <div class="panel-section">
    <h3>Connections</h3>
    <div class="check-group" id="connTypes"></div>
  </div>
  <div class="state-diagram">
    <h3>Job Order State Machine</h3>
    <div class="state-flow"><span class="s-wait">WAITING</span> →start→ <span class="s-run">RUNNING</span> →complete→ <span class="s-done">DONE</span>
    ↘pause→ <span class="s-pause">PAUSED</span> →start→ <span class="s-run">RUNNING</span>
<span class="s-wait">WAITING</span>/<span class="s-pause">PAUSED</span> →cancel→ <span class="s-cancel">CANCELED</span></div>
  </div>
  <div class="comments-area">
    <h3>Comments (<span id="commentCount">0</span>)</h3>
    <div id="commentList"><p class="no-comments">노드를 클릭하여 코멘트 추가</p></div>
  </div>
</div>

<!-- Main -->
<div class="main">
  <div class="toolbar">
    <div class="title"><span>생산관리</span> — Production Flow Explorer</div>
    <span class="ep-badge">37 API endpoints</span>
    <button class="zoom-btn" onclick="zoom(-1)">−</button>
    <span class="zoom-label" id="zoomLabel">100%</span>
    <button class="zoom-btn" onclick="zoom(1)">+</button>
    <button class="zoom-btn" onclick="zoom(0)">⌂</button>
  </div>
  <div class="canvas-wrap" id="canvasWrap">
    <svg id="svg" xmlns="http://www.w3.org/2000/svg"></svg>
    <div class="legend">
      <h4>Legend</h4>
      <div class="legend-row"><span class="color-dot" style="background:#93c5fd"></span> 페이지 (11p)</div>
      <div class="legend-row"><span class="color-dot" style="background:#7dd3fc"></span> 컴포넌트 / 모달</div>
      <div class="legend-row"><span class="color-dot" style="background:#a78bfa"></span> Store / Hooks</div>
      <div class="legend-row"><span class="color-dot" style="background:#818cf8"></span> API Proxy</div>
      <div class="legend-row"><span class="color-dot" style="background:#fcd34d"></span> Controller (37 EP)</div>
      <div class="legend-row"><span class="color-dot" style="background:#fbbf24"></span> Service (비즈니스)</div>
      <div class="legend-row"><span class="color-dot" style="background:#86efac"></span> 크로스모듈</div>
      <div class="legend-row"><span class="color-dot" style="background:#c4b5fd"></span> Entity / ORM</div>
      <div class="legend-row"><span class="color-dot" style="background:#f9a8d4"></span> Database</div>
    </div>
  </div>
  <div class="prompt-area">
    <div class="prompt-header"><h3>Generated Prompt</h3><button class="copy-btn" id="copyBtn" onclick="copyPrompt()">Copy</button></div>
    <div class="prompt-text" id="promptText">생산관리 전체 흐름을 표시 중입니다.</div>
  </div>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modal">
  <div class="modal">
    <h3 id="modalTitle"></h3>
    <div class="modal-file" id="modalFile"></div>
    <textarea id="modalText" placeholder="이 컴포넌트에 대한 피드백을 입력하세요..."></textarea>
    <div class="modal-actions">
      <button class="cancel" onclick="closeModal()">취소</button>
      <button class="save" onclick="saveComment()">저장</button>
    </div>
  </div>
</div>
<div class="tooltip" id="tooltip"><div class="tt-label"></div><div class="tt-file"></div><div class="tt-detail"></div><div class="tt-endpoints"></div></div>

<script>
/** @file Production Flow Explorer — HANES MES 생산관리 상세 코드맵 */

const LAYERS = {
  pages:    { label:'페이지 (11p)',       color:'#93c5fd', fill:'#1e3a5f', stroke:'#3b82f6' },
  comps:    { label:'컴포넌트 / 모달',    color:'#7dd3fc', fill:'#164e63', stroke:'#06b6d4' },
  state:    { label:'Store / Hooks',      color:'#a78bfa', fill:'#2e1065', stroke:'#8b5cf6' },
  proxy:    { label:'API Proxy',          color:'#818cf8', fill:'#312e81', stroke:'#6366f1' },
  ctrl:     { label:'Controller (37 EP)', color:'#fcd34d', fill:'#713f12', stroke:'#eab308' },
  svc:      { label:'Service (비즈니스)', color:'#fbbf24', fill:'#78350f', stroke:'#f59e0b' },
  xmod:     { label:'크로스모듈',         color:'#86efac', fill:'#14532d', stroke:'#22c55e' },
  entity:   { label:'Entity / ORM',       color:'#c4b5fd', fill:'#3b0764', stroke:'#a855f7' },
  database: { label:'Database',           color:'#f9a8d4', fill:'#831843', stroke:'#ec4899' }
};

const CONN = {
  'data':  { label:'Data Flow (HTTP)',    color:'#3b82f6', dash:'' },
  'dep':   { label:'Dependency (import)', color:'#6b7280', dash:'4,3' },
  'state': { label:'State / Event',       color:'#f59e0b', dash:'6,3' },
  'inject':{ label:'DI / Interceptor',    color:'#10b981', dash:'8,4' },
  'xmod':  { label:'Cross-module',        color:'#ec4899', dash:'3,5' }
};

const W=140, H=44, SW=160;

const nodes = [
  // Row 1: Pages (y:30)
  { id:'p-order',     label:'작업지시',       subtitle:'production/order/',          detail:'작업지시 CRUD, BOM 반제품 자동생성, 트리뷰', endpoints:'GET/POST/PUT/DELETE + start/pause/complete/cancel', x:20,  y:30, w:W, h:H, layer:'pages' },
  { id:'p-progress',  label:'작업진행현황',   subtitle:'production/progress/',       detail:'작업지시 진행률 모니터링, 상태별 통계', endpoints:'GET /progress', x:170, y:30, w:W, h:H, layer:'pages' },
  { id:'p-result',    label:'생산실적',       subtitle:'production/result/',         detail:'실적 목록, 공정별/설비별/작업자별 조회', endpoints:'GET /prod-results', x:320, y:30, w:W, h:H, layer:'pages' },
  { id:'p-summary',   label:'실적 요약',      subtitle:'production/result-summary/', detail:'완제품별 통합 집계 (달성률/수율/불량률)', endpoints:'GET /summary/by-product', x:470, y:30, w:W, h:H, layer:'pages' },
  { id:'p-manual',    label:'수동입력',        subtitle:'production/input-manual/',   detail:'수동 실적 입력 (작업자+작업지시 선택)', endpoints:'POST /prod-results', x:620, y:30, w:W, h:H, layer:'pages' },
  { id:'p-machine',   label:'기계입력',        subtitle:'production/input-machine/',  detail:'기계 실적 입력 (설비점검 확인 필수)', endpoints:'POST /prod-results', x:770, y:30, w:W, h:H, layer:'pages' },
  { id:'p-inspect',   label:'검사입력',        subtitle:'production/input-inspect/',  detail:'검사 실적 입력', endpoints:'POST /prod-results', x:920, y:30, w:W, h:H, layer:'pages' },
  { id:'p-equip',     label:'설비입력',        subtitle:'production/input-equip/',    detail:'설비 실적 입력 (WorkOrderContext)', endpoints:'POST /prod-results', x:1070,y:30, w:W, h:H, layer:'pages' },
  { id:'p-sample',    label:'샘플검사',        subtitle:'production/sample-inspect/', detail:'샘플검사 이력 + 일괄입력 (자동 합불판정)', endpoints:'GET/POST /sample-inspect-input', x:1220,y:30, w:W, h:H, layer:'pages' },
  { id:'p-pack',      label:'포장실적',        subtitle:'production/pack-result/',    detail:'포장 실적 조회 (BoxMaster)', endpoints:'GET /pack-result', x:1370,y:30, w:W, h:H, layer:'pages' },
  { id:'p-wip',       label:'WIP 재고',        subtitle:'production/wip-stock/',      detail:'반제품/제품 재고 현황 (Stock + PartMaster)', endpoints:'GET /wip-stock', x:1520,y:30, w:W, h:H, layer:'pages' },

  // Row 2: Components (y:120)
  { id:'c-create-jo', label:'CreateJobOrderModal', subtitle:'order/components/',     detail:'작업지시 생성 모달 (GET /master/parts + POST /job-orders, autoCreateChildren)', x:20,  y:120, w:SW, h:H, layer:'comps' },
  { id:'c-jo-select', label:'JobOrderSelectModal',subtitle:'components/production/', detail:'작업지시 선택 모달 (현재 mock data → API 미연동)', x:200, y:120, w:SW, h:H, layer:'comps' },
  { id:'c-worker',    label:'WorkerSelectModal',  subtitle:'components/worker/',     detail:'작업자 선택/검색 모달 + WorkerAvatar', x:380, y:120, w:SW, h:H, layer:'comps' },
  { id:'c-sample-m',  label:'SampleInspectModal', subtitle:'sample-inspect/components/',detail:'샘플검사 일괄입력 (specUpper/Lower 자동판정)', x:560, y:120, w:SW, h:H, layer:'comps' },
  { id:'c-wo-ctx',    label:'WorkOrderContext',   subtitle:'components/production/', detail:'설비입력용 작업지시 컨텍스트 (React Context)', x:740, y:120, w:SW, h:H, layer:'comps' },
  { id:'c-grid',      label:'DataGrid',           subtitle:'components/data-grid/',  detail:'TanStack Table 기반 공통 테이블 (정렬/필터/페이징/엑셀)', x:920, y:120, w:W, h:H, layer:'comps' },
  { id:'c-badge',     label:'ComCodeBadge',       subtitle:'components/ui/',         detail:'JOB_ORDER_STATUS, PROCESS_TYPE, JUDGE_YN 공통코드 배지', x:1080,y:120, w:W, h:H, layer:'comps' },
  { id:'c-stat',      label:'StatCard',           subtitle:'components/ui/',         detail:'대시보드 통계 카드 (각 페이지 3~4개)', x:1240,y:120, w:W, h:H, layer:'comps' },

  // Row 3: Stores + Hooks (y:210)
  { id:'s-manual',    label:'inputManualStore',   subtitle:'stores/inputManualStore', detail:'selectedJobOrder, selectedWorker (localStorage persist)', x:40,  y:210, w:SW, h:H, layer:'state' },
  { id:'s-machine',   label:'inputMachineStore',  subtitle:'stores/inputMachineStore',detail:'selectedJobOrder, selectedWorker + inspectConfirmed', x:220, y:210, w:SW, h:H, layer:'state' },
  { id:'s-inspect',   label:'inputInspectStore',  subtitle:'stores/inputInspectStore',detail:'selectedJobOrder, selectedWorker', x:400, y:210, w:SW, h:H, layer:'state' },
  { id:'s-prod',      label:'productionInputStore',subtitle:'stores/productionInputStore',detail:'공통 생산입력 상태 (부모 store)', x:580, y:210, w:SW, h:H, layer:'state' },
  { id:'h-api',       label:'useApi / React Query',subtitle:'hooks/useApi.ts',       detail:'useApiQuery, useApiMutation, usePaginatedQuery (staleTime 5m)', x:780, y:210, w:SW, h:H, layer:'state' },
  { id:'h-comcode',   label:'useComCode',         subtitle:'hooks/useComCode.ts',    detail:'useComCodeOptions("JOB_ORDER_STATUS"), useComCodeLabel', x:960, y:210, w:W, h:H, layer:'state' },
  { id:'h-axios',     label:'Axios Instance',     subtitle:'services/api.ts',        detail:'Bearer + X-Company 헤더, 401 리다이렉트', x:1120,y:210, w:W, h:H, layer:'state' },

  // Row 4: Proxy (y:300)
  { id:'proxy',       label:'Next.js Rewrites',   subtitle:'next.config.ts',         detail:'/api/* → localhost:3003/api/v1/* (CORS 우회)', x:600, y:300, w:200, h:H, layer:'proxy' },

  // Row 5: Controllers (y:390)
  { id:'ctrl-jo',     label:'JobOrderCtrl (16)',   subtitle:'controllers/job-order',  detail:'CRUD + start/pause/complete/cancel + tree/erp-sync', endpoints:'16 endpoints', x:60,  y:390, w:SW, h:H, layer:'ctrl' },
  { id:'ctrl-pr',     label:'ProdResultCtrl (14)', subtitle:'controllers/prod-result',detail:'CRUD + complete/cancel + summary (daily/equip/worker/product)', endpoints:'14 endpoints', x:260, y:390, w:SW, h:H, layer:'ctrl' },
  { id:'ctrl-view',   label:'ViewsCtrl (4)',       subtitle:'controllers/prod-views', detail:'progress, sample-inspect, pack-result, wip-stock', endpoints:'4 endpoints', x:460, y:390, w:SW, h:H, layer:'ctrl' },
  { id:'ctrl-si',     label:'SampleInspectCtrl (3)',subtitle:'controllers/sample-inspect',detail:'GET 이력 + GET by jobOrder + POST 일괄입력', endpoints:'3 endpoints', x:660, y:390, w:SW, h:H, layer:'ctrl' },

  // Row 6: Services (y:480)
  { id:'svc-jo',      label:'JobOrderService',    subtitle:'services/job-order',     detail:'BOM 반제품 자동생성, 완료 시 실적 자동집계 (goodQty/defectQty)', x:60,  y:480, w:SW, h:H, layer:'svc' },
  { id:'svc-pr',      label:'ProdResultService',  subtitle:'services/prod-result',   detail:'집계 API (일별/설비별/작업자별/품목별), 불량로그 조인', x:260, y:480, w:SW, h:H, layer:'svc' },
  { id:'svc-view',    label:'ViewsService',       subtitle:'services/prod-views',    detail:'Stock+PartMaster JOIN(WIP/FG), BoxMaster(포장), InspectResult(검사)', x:460, y:480, w:SW, h:H, layer:'svc' },
  { id:'svc-si',      label:'SampleInspectSvc',   subtitle:'services/sample-inspect',detail:'트랜잭션 일괄저장, JobOrder→PartMaster JOIN 검색', x:660, y:480, w:SW, h:H, layer:'svc' },

  // Row 7: Cross-module (y:570)
  { id:'x-mat',       label:'Material (MatIssue)', subtitle:'modules/material/',     detail:'jobOrderId로 자재불출 추적, issueType=PROD', x:40,  y:570, w:SW, h:H, layer:'xmod' },
  { id:'x-master',    label:'Master (BOM/Part)',   subtitle:'modules/master/',       detail:'BomMaster→WIP 반제품 자동생성, PartMaster→품목정보', x:240, y:570, w:SW, h:H, layer:'xmod' },
  { id:'x-equip',     label:'Equipment',           subtitle:'modules/equipment/',    detail:'EquipMaster→설비 유효성검증, 설비별 실적집계', x:440, y:570, w:SW, h:H, layer:'xmod' },
  { id:'x-quality',   label:'Quality (Inspect)',   subtitle:'modules/quality/',      detail:'InspectResult→ProdResult 연결, passYn=N 불량필터', x:640, y:570, w:SW, h:H, layer:'xmod' },
  { id:'x-inventory', label:'Inventory (Stock)',   subtitle:'modules/inventory/',    detail:'Stock→WIP/FG 재고, BoxMaster→포장실적', x:840, y:570, w:SW, h:H, layer:'xmod' },
  { id:'x-user',      label:'User (Worker)',       subtitle:'modules/user/',         detail:'User→작업자 유효성검증, 작업자별 실적집계', x:1040,y:570, w:SW, h:H, layer:'xmod' },

  // Row 8: Entities (y:660)
  { id:'e-jo',        label:'JobOrder',            subtitle:'entities/job-order',     detail:'ORDER_NO, PART_ID, PLAN_QTY, STATUS, PARENT_ID(계층), ERP_SYNC_YN', x:40,  y:660, w:W, h:H, layer:'entity' },
  { id:'e-pr',        label:'ProdResult',          subtitle:'entities/prod-result',   detail:'JOB_ORDER_ID, EQUIP_ID, WORKER_ID, LOT_NO, GOOD/DEFECT_QTY, CYCLE_TIME', x:200, y:660, w:W, h:H, layer:'entity' },
  { id:'e-si',        label:'SampleInspectResult', subtitle:'entities/sample-inspect',detail:'JOB_ORDER_ID, SAMPLE_NO, MEASURED_VALUE, SPEC_UPPER/LOWER, PASS_YN', x:360, y:660, w:SW, h:H, layer:'entity' },
  { id:'e-part',      label:'PartMaster',          subtitle:'entities/part-master',   detail:'PART_CODE, PART_NAME, PART_TYPE(RAW/WIP/FG), UOM', x:540, y:660, w:W, h:H, layer:'entity' },
  { id:'e-bom',       label:'BomMaster',           subtitle:'entities/bom-master',    detail:'PARENT_PART_ID, CHILD_PART_ID, QTY_PER, BOM_TYPE', x:700, y:660, w:W, h:H, layer:'entity' },
  { id:'e-equip',     label:'EquipMaster',         subtitle:'entities/equip-master',  detail:'EQUIP_CODE, EQUIP_NAME, STATUS, PROCESS_CODE', x:860, y:660, w:W, h:H, layer:'entity' },
  { id:'e-inspect',   label:'InspectResult',       subtitle:'entities/inspect-result',detail:'PROD_RESULT_ID, INSPECT_ITEM, PASS_YN, MEASURED_VALUE', x:1020,y:660, w:W, h:H, layer:'entity' },
  { id:'e-stock',     label:'Stock',               subtitle:'entities/stock',         detail:'PART_ID, WH_CODE, QTY, LOT_NO (WIP/FG 필터)', x:1180,y:660, w:W, h:H, layer:'entity' },
  { id:'e-box',       label:'BoxMaster',           subtitle:'entities/box-master',    detail:'BOX_NO, LOT_NO, QTY, STATUS (포장실적)', x:1340,y:660, w:W, h:H, layer:'entity' },

  // Row 9: DB (y:750)
  { id:'db',          label:'Oracle Database',     subtitle:'oracledb driver',        detail:'poolMax:10, poolMin:2, TypeORM synchronize:false', x:580, y:750, w:220, h:48, layer:'database' }
];

const connections = [
  // Pages → Components
  { from:'p-order',   to:'c-create-jo', type:'dep' },
  { from:'p-order',   to:'c-grid',      type:'dep' },
  { from:'p-order',   to:'c-badge',     type:'dep', label:'JOB_ORDER_STATUS' },
  { from:'p-order',   to:'c-stat',      type:'dep' },
  { from:'p-manual',  to:'c-jo-select', type:'dep' },
  { from:'p-manual',  to:'c-worker',    type:'dep' },
  { from:'p-machine', to:'c-jo-select', type:'dep' },
  { from:'p-machine', to:'c-worker',    type:'dep' },
  { from:'p-inspect', to:'c-jo-select', type:'dep' },
  { from:'p-inspect', to:'c-worker',    type:'dep' },
  { from:'p-equip',   to:'c-wo-ctx',    type:'dep' },
  { from:'p-sample',  to:'c-sample-m',  type:'dep' },
  { from:'p-result',  to:'c-grid',      type:'dep' },
  { from:'p-result',  to:'c-badge',     type:'dep', label:'PROCESS_TYPE' },
  { from:'p-progress',to:'c-badge',     type:'dep' },
  { from:'p-summary', to:'c-grid',      type:'dep' },

  // Pages → Stores
  { from:'p-manual',  to:'s-manual',    type:'state', label:'persist' },
  { from:'p-machine', to:'s-machine',   type:'state', label:'persist' },
  { from:'p-inspect', to:'s-inspect',   type:'state', label:'persist' },
  { from:'p-equip',   to:'s-prod',      type:'state' },

  // Pages → Hooks
  { from:'p-order',   to:'h-api',       type:'data' },
  { from:'p-result',  to:'h-api',       type:'data' },
  { from:'p-summary', to:'h-api',       type:'data' },
  { from:'p-progress',to:'h-api',       type:'data' },
  { from:'p-sample',  to:'h-api',       type:'data' },
  { from:'p-pack',    to:'h-api',       type:'data' },
  { from:'p-wip',     to:'h-api',       type:'data' },
  { from:'p-manual',  to:'h-api',       type:'data' },
  { from:'p-machine', to:'h-api',       type:'data' },
  { from:'p-inspect', to:'h-api',       type:'data' },
  { from:'p-equip',   to:'h-api',       type:'data' },
  { from:'c-badge',   to:'h-comcode',   type:'dep' },

  // Hooks → Axios → Proxy
  { from:'h-api',     to:'h-axios',     type:'data', label:'HTTP' },
  { from:'h-axios',   to:'proxy',       type:'data', label:'/api/*' },

  // Proxy → Controllers
  { from:'proxy',     to:'ctrl-jo',     type:'data', label:'/job-orders' },
  { from:'proxy',     to:'ctrl-pr',     type:'data', label:'/prod-results' },
  { from:'proxy',     to:'ctrl-view',   type:'data', label:'/production/*' },
  { from:'proxy',     to:'ctrl-si',     type:'data', label:'/sample-inspect-input' },

  // Controllers → Services
  { from:'ctrl-jo',   to:'svc-jo',      type:'inject' },
  { from:'ctrl-pr',   to:'svc-pr',      type:'inject' },
  { from:'ctrl-view', to:'svc-view',    type:'inject' },
  { from:'ctrl-si',   to:'svc-si',      type:'inject' },

  // Services → Cross-module
  { from:'svc-jo',    to:'x-master',    type:'xmod', label:'BOM 반제품' },
  { from:'svc-pr',    to:'x-equip',     type:'xmod', label:'설비 검증' },
  { from:'svc-pr',    to:'x-user',      type:'xmod', label:'작업자 검증' },
  { from:'svc-pr',    to:'x-quality',   type:'xmod', label:'불량 필터' },
  { from:'svc-view',  to:'x-inventory', type:'xmod', label:'WIP/FG 재고' },
  { from:'svc-view',  to:'x-quality',   type:'xmod', label:'검사이력' },
  { from:'svc-si',    to:'x-master',    type:'xmod', label:'품목정보' },
  { from:'x-mat',     to:'svc-jo',      type:'xmod', label:'자재불출 연결' },

  // Services → Entities
  { from:'svc-jo',    to:'e-jo',        type:'dep' },
  { from:'svc-jo',    to:'e-part',      type:'dep' },
  { from:'svc-jo',    to:'e-bom',       type:'dep' },
  { from:'svc-pr',    to:'e-pr',        type:'dep' },
  { from:'svc-pr',    to:'e-equip',     type:'dep' },
  { from:'svc-pr',    to:'e-inspect',   type:'dep' },
  { from:'svc-view',  to:'e-stock',     type:'dep' },
  { from:'svc-view',  to:'e-box',       type:'dep' },
  { from:'svc-view',  to:'e-inspect',   type:'dep' },
  { from:'svc-si',    to:'e-si',        type:'dep' },
  { from:'svc-si',    to:'e-jo',        type:'dep' },

  // Cross-module → Entities
  { from:'x-mat',     to:'e-jo',        type:'xmod' },
  { from:'x-master',  to:'e-part',      type:'dep' },
  { from:'x-master',  to:'e-bom',       type:'dep' },
  { from:'x-equip',   to:'e-equip',     type:'dep' },
  { from:'x-quality', to:'e-inspect',   type:'dep' },
  { from:'x-inventory',to:'e-stock',    type:'dep' },
  { from:'x-inventory',to:'e-box',      type:'dep' },

  // Entities → DB
  { from:'e-jo',      to:'db',          type:'data', label:'TypeORM' },
  { from:'e-pr',      to:'db',          type:'data' },
  { from:'e-si',      to:'db',          type:'data' },
  { from:'e-part',    to:'db',          type:'data' },
  { from:'e-bom',     to:'db',          type:'data' },
  { from:'e-equip',   to:'db',          type:'data' },
  { from:'e-inspect', to:'db',          type:'data' },
  { from:'e-stock',   to:'db',          type:'data' },
  { from:'e-box',     to:'db',          type:'data' },

  // Entity relations
  { from:'e-pr',      to:'e-jo',        type:'dep', label:'FK' },
  { from:'e-si',      to:'e-jo',        type:'dep', label:'FK' },
  { from:'e-inspect', to:'e-pr',        type:'dep', label:'FK' },
];

const PRESETS = {
  '전체 시스템':     { layers: Object.keys(LAYERS), conns: Object.keys(CONN) },
  '작업지시 흐름':   { layers:['pages','comps','state','proxy','ctrl','svc','entity','database'], conns:['data','dep','inject'], hl:['p-order','c-create-jo','c-badge','c-grid','h-api','h-axios','proxy','ctrl-jo','svc-jo','e-jo','e-part','e-bom','db'] },
  '실적 입력 흐름':  { layers:['pages','comps','state','proxy','ctrl','svc','entity','database'], conns:['data','state','inject','dep'], hl:['p-manual','p-machine','p-inspect','p-equip','c-jo-select','c-worker','c-wo-ctx','s-manual','s-machine','s-inspect','s-prod','h-api','h-axios','proxy','ctrl-pr','svc-pr','e-pr','e-jo','db'] },
  '샘플검사 흐름':   { layers:['pages','comps','state','proxy','ctrl','svc','entity','database'], conns:['data','dep','inject'], hl:['p-sample','c-sample-m','h-api','h-axios','proxy','ctrl-si','svc-si','e-si','e-jo','e-part','db'] },
  '크로스모듈':      { layers:['svc','xmod','entity'], conns:['xmod','dep'], hl:null },
  '실적 집계':       { layers:['pages','state','proxy','ctrl','svc','entity','database'], conns:['data','inject','dep'], hl:['p-summary','p-progress','p-result','p-pack','p-wip','h-api','h-axios','proxy','ctrl-pr','ctrl-view','svc-pr','svc-view','e-pr','e-jo','e-stock','e-box','e-inspect','db'] },
  '엔티티 관계':     { layers:['entity','database'], conns:['dep','data'], hl:null },
};

/* State */
const state = { layers:{}, conns:{}, comments:[], zoom:1, panX:0, panY:0, preset:'전체 시스템', modalNode:null, hl:null, drag:false, dx:0, dy:0, dpx:0, dpy:0 };
Object.keys(LAYERS).forEach(k=>state.layers[k]=true);
Object.keys(CONN).forEach(k=>state.conns[k]=true);

/* Render */
const svg=document.getElementById('svg'), wrap=document.getElementById('canvasWrap');

function render(){
  const vw=1720, vh=840;
  svg.setAttribute('viewBox',`${-state.panX/state.zoom} ${-state.panY/state.zoom} ${vw/state.zoom} ${vh/state.zoom}`);
  let h=`<defs>`;
  Object.entries(CONN).forEach(([k,v])=>{
    h+=`<marker id="a-${k}" markerWidth="7" markerHeight="5" refX="6" refY="2.5" orient="auto"><polygon points="0 0,7 2.5,0 5" fill="${v.color}" opacity=".7"/></marker>`;
  });
  h+=`</defs>`;

  // Connections
  connections.forEach(c=>{
    if(!state.conns[c.type])return;
    const f=nodes.find(n=>n.id===c.from),t=nodes.find(n=>n.id===c.to);
    if(!f||!t||!state.layers[f.layer]||!state.layers[t.layer])return;
    const ct=CONN[c.type];
    let x1=f.x+f.w/2,y1=f.y+f.h,x2=t.x+t.w/2,y2=t.y;
    // Same row? use side connection
    if(Math.abs(f.y-t.y)<10){ x1=f.x+f.w; y1=f.y+f.h/2; x2=t.x; y2=t.y+t.h/2;
      const mx=(x1+x2)/2;
      const isHl=state.hl?state.hl.includes(f.id)&&state.hl.includes(t.id):true;
      h+=`<path d="M${x1},${y1} C${mx},${y1} ${mx},${y2} ${x2},${y2}" fill="none" stroke="${ct.color}" stroke-width="1.3" opacity="${isHl?.45:.08}" stroke-dasharray="${ct.dash}" marker-end="url(#a-${c.type})"/>`;
      return;
    }
    const dy=y2-y1,cy1=y1+dy*.35,cy2=y2-dy*.35;
    const isHl=state.hl?state.hl.includes(f.id)&&state.hl.includes(t.id):true;
    const op=isHl?.45:.08;
    h+=`<path d="M${x1},${y1} C${x1},${cy1} ${x2},${cy2} ${x2},${y2}" fill="none" stroke="${ct.color}" stroke-width="1.3" opacity="${op}" stroke-dasharray="${ct.dash}" marker-end="url(#a-${c.type})"/>`;
    if(c.label&&isHl){const mx=(x1+x2)/2,my=(y1+y2)/2; h+=`<text x="${mx}" y="${my-3}" text-anchor="middle" fill="${ct.color}" font-size="8" opacity=".65">${c.label}</text>`;}
  });

  // Nodes
  nodes.forEach(n=>{
    if(!state.layers[n.layer])return;
    const L=LAYERS[n.layer],hasCmt=state.comments.some(c=>c.target===n.id);
    const isHl=state.hl?state.hl.includes(n.id):true;
    h+=`<g class="node" data-id="${n.id}" style="cursor:pointer;opacity:${isHl?1:.2}" onmouseenter="showTip(event,'${n.id}')" onmouseleave="hideTip()" onclick="openModal('${n.id}')">`;
    h+=`<rect x="${n.x}" y="${n.y}" width="${n.w}" height="${n.h}" rx="7" fill="${L.fill}" stroke="${hasCmt?'#f59e0b':L.stroke}" stroke-width="${hasCmt?2.2:1}"/>`;
    h+=`<text x="${n.x+n.w/2}" y="${n.y+n.h/2-5}" text-anchor="middle" fill="${L.color}" font-size="10" font-weight="600">${n.label}</text>`;
    h+=`<text x="${n.x+n.w/2}" y="${n.y+n.h/2+8}" text-anchor="middle" fill="#64748b" font-size="7.5">${n.subtitle}</text>`;
    if(hasCmt){const cnt=state.comments.filter(c=>c.target===n.id).length; h+=`<circle cx="${n.x+n.w-5}" cy="${n.y+5}" r="4.5" fill="#f59e0b"/><text x="${n.x+n.w-5}" y="${n.y+8}" text-anchor="middle" fill="#0f172a" font-size="6.5" font-weight="700">${cnt}</text>`;}
    h+=`</g>`;
  });
  svg.innerHTML=h;
  updatePrompt();
}

/* Controls */
function buildControls(){
  document.getElementById('presets').innerHTML=Object.keys(PRESETS).map(k=>`<button class="preset-btn${state.preset===k?' active':''}" onclick="applyPreset('${k}')">${k}</button>`).join('');
  document.getElementById('layers').innerHTML=Object.entries(LAYERS).map(([k,v])=>`<label class="check-item"><input type="checkbox" ${state.layers[k]?'checked':''} onchange="toggleL('${k}',this.checked)"><span class="color-dot" style="background:${v.color}"></span>${v.label}</label>`).join('');
  document.getElementById('connTypes').innerHTML=Object.entries(CONN).map(([k,v])=>`<label class="check-item"><input type="checkbox" ${state.conns[k]?'checked':''} onchange="toggleC('${k}',this.checked)"><span class="line-sample" style="background:${v.color}"></span>${v.label}</label>`).join('');
}

function applyPreset(n){ const p=PRESETS[n]; state.preset=n; Object.keys(LAYERS).forEach(k=>state.layers[k]=p.layers.includes(k)); Object.keys(CONN).forEach(k=>state.conns[k]=p.conns.includes(k)); state.hl=p.hl||null; buildControls(); render(); }
function toggleL(k,v){state.layers[k]=v;state.preset='';buildControls();render();}
function toggleC(k,v){state.conns[k]=v;state.preset='';buildControls();render();}

/* Zoom & Pan */
function zoom(d){if(d===0){state.zoom=1;state.panX=0;state.panY=0;}else state.zoom=Math.max(.25,Math.min(3,state.zoom+d*.15));document.getElementById('zoomLabel').textContent=Math.round(state.zoom*100)+'%';render();}
wrap.addEventListener('wheel',e=>{e.preventDefault();zoom(e.deltaY<0?1:-1);},{passive:false});
wrap.addEventListener('mousedown',e=>{if(e.target.closest('.node'))return;state.drag=true;state.dx=e.clientX;state.dy=e.clientY;state.dpx=state.panX;state.dpy=state.panY;wrap.style.cursor='grabbing';});
window.addEventListener('mousemove',e=>{if(!state.drag)return;state.panX=state.dpx+(e.clientX-state.dx);state.panY=state.dpy+(e.clientY-state.dy);render();});
window.addEventListener('mouseup',()=>{state.drag=false;wrap.style.cursor='';});

/* Tooltip */
const tip=document.getElementById('tooltip');
function showTip(e,id){const n=nodes.find(x=>x.id===id);if(!n)return;tip.querySelector('.tt-label').textContent=n.label;tip.querySelector('.tt-file').textContent=n.subtitle;tip.querySelector('.tt-detail').textContent=n.detail;tip.querySelector('.tt-endpoints').textContent=n.endpoints||'';tip.style.display='block';tip.style.left=(e.clientX+12)+'px';tip.style.top=(e.clientY-8)+'px';}
function hideTip(){tip.style.display='none';}

/* Comments */
function openModal(id){const n=nodes.find(x=>x.id===id);if(!n)return;state.modalNode=n;document.getElementById('modalTitle').textContent=n.label;document.getElementById('modalFile').textContent=n.subtitle;document.getElementById('modalText').value='';document.getElementById('modal').classList.add('show');setTimeout(()=>document.getElementById('modalText').focus(),80);}
function closeModal(){document.getElementById('modal').classList.remove('show');state.modalNode=null;}
function saveComment(){const t=document.getElementById('modalText').value.trim();if(!t||!state.modalNode)return;state.comments.push({id:Date.now(),target:state.modalNode.id,targetLabel:state.modalNode.label,targetFile:state.modalNode.subtitle,text:t});closeModal();renderComments();render();}
function deleteComment(id){state.comments=state.comments.filter(c=>c.id!==id);renderComments();render();}
function renderComments(){const el=document.getElementById('commentList');document.getElementById('commentCount').textContent=state.comments.length;if(!state.comments.length){el.innerHTML='<p class="no-comments">노드를 클릭하여 코멘트 추가</p>';return;}el.innerHTML=state.comments.map(c=>`<div class="comment-item"><span class="target">${c.targetLabel}</span> <span class="file">${c.targetFile}</span><div class="text">${c.text}</div><button class="del-btn" onclick="deleteComment(${c.id})">×</button></div>`).join('');}
document.getElementById('modalText').addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();saveComment();}});
document.getElementById('modal').addEventListener('click',e=>{if(e.target===document.getElementById('modal'))closeModal();});

/* Prompt */
function updatePrompt(){
  const vis=Object.entries(state.layers).filter(([,v])=>v).map(([k])=>LAYERS[k].label);
  let t=`HANES MES 생산관리 흐름 — ${state.preset||'Custom'}\n표시: ${vis.join(', ')}\n`;
  if(state.hl)t+=`하이라이트: ${state.hl.length}개 노드\n`;
  if(state.comments.length){t+=`\n--- 피드백 ---\n`;state.comments.forEach(c=>{t+=`\n**${c.targetLabel}** (${c.targetFile}):\n${c.text}\n`;});}
  else t+=`\n노드를 클릭하여 피드백을 추가하세요.`;
  document.getElementById('promptText').textContent=t;
}
function copyPrompt(){const t=document.getElementById('promptText').textContent;navigator.clipboard.writeText(t);const b=document.getElementById('copyBtn');b.textContent='Copied!';b.classList.add('copied');setTimeout(()=>{b.textContent='Copy';b.classList.remove('copied');},1500);}

/* Init */
buildControls();render();
</script>
</body>
</html>
