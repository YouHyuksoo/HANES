-- ============================================================
-- PROD_PLANS 테이블 생성 + JOB_ORDERS에 PLAN_ID 추가
-- 실행 대상: Oracle (JSHANES)
-- ============================================================

-- 1. PROD_PLANS 테이블
CREATE TABLE PROD_PLANS (
  ID            NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  PLAN_NO       VARCHAR2(50)  NOT NULL UNIQUE,   -- PP-YYYYMM-NNN
  PLAN_MONTH    VARCHAR2(7)   NOT NULL,           -- YYYY-MM
  ITEM_CODE     VARCHAR2(50)  NOT NULL,           -- FK → ITEM_MASTERS
  ITEM_TYPE     VARCHAR2(10)  NOT NULL,           -- FG / WIP
  PLAN_QTY      NUMBER(10)    NOT NULL,
  ORDER_QTY     NUMBER(10)    DEFAULT 0,          -- 작업지시 발행 누적수량
  CUSTOMER      VARCHAR2(50),
  LINE_CODE     VARCHAR2(255),
  PRIORITY      NUMBER(2)     DEFAULT 5,
  STATUS        VARCHAR2(20)  DEFAULT 'DRAFT',    -- DRAFT → CONFIRMED → CLOSED
  REMARK        VARCHAR2(500),
  COMPANY       VARCHAR2(255),
  PLANT_CD      VARCHAR2(255),
  CREATED_BY    VARCHAR2(255),
  UPDATED_BY    VARCHAR2(255),
  CREATED_AT    TIMESTAMP     DEFAULT SYSTIMESTAMP,
  UPDATED_AT    TIMESTAMP     DEFAULT SYSTIMESTAMP
);

-- 인덱스
CREATE INDEX IDX_PROD_PLANS_MONTH  ON PROD_PLANS (PLAN_MONTH);
CREATE INDEX IDX_PROD_PLANS_STATUS ON PROD_PLANS (STATUS);

-- 2. JOB_ORDERS에 PLAN_ID 컬럼 추가
ALTER TABLE JOB_ORDERS ADD (PLAN_ID NUMBER NULL);

-- 3. ComCode 등록 (PROD_PLAN_STATUS)
INSERT INTO COM_CODES (GROUP_CODE, CODE, CODE_NAME, SORT_ORDER, USE_YN, COMPANY)
VALUES ('PROD_PLAN_STATUS', 'DRAFT', '초안', 1, 'Y', '40');

INSERT INTO COM_CODES (GROUP_CODE, CODE, CODE_NAME, SORT_ORDER, USE_YN, COMPANY)
VALUES ('PROD_PLAN_STATUS', 'CONFIRMED', '확정', 2, 'Y', '40');

INSERT INTO COM_CODES (GROUP_CODE, CODE, CODE_NAME, SORT_ORDER, USE_YN, COMPANY)
VALUES ('PROD_PLAN_STATUS', 'CLOSED', '마감', 3, 'Y', '40');

COMMIT;
